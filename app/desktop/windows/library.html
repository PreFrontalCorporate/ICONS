<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>icon – library</title>
    <style>
      /* Kill margins, make webview truly full-bleed */
      html, body { height: 100%; margin: 0; background: #111; }
      #libview {
        position: fixed;
        inset: 0;              /* fills the window; no huge black bands */
        border: 0;
      }
      /* Small HUD in front of the webview */
      #hud {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 10;
        background: rgba(0,0,0,.8);
        color: #fff;
        padding: 12px 14px;
        border-radius: 12px;
        font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        box-shadow: 0 10px 24px rgba(0,0,0,.35);
        max-width: 320px;
      }
      #hud button {
        appearance: none; border: 0; border-radius: 10px; padding: 6px 10px;
        background: #ef4444; color: #fff; font-weight: 600; cursor: pointer;
      }
      #count { font-variant-numeric: tabular-nums; }
    </style>
  </head>
  <body>
    <!-- The hosted library UI -->
    <webview id="libview" src="https://icon-web-two.vercel.app/library" allowpopups></webview>

    <!-- Minimal overlays HUD -->
    <div id="hud" role="status" aria-live="polite">
      <strong>Overlays</strong> <span id="count">0</span>
      <button id="clear" title="Close all overlays">Clear</button>
      <div style="opacity:.7;margin-top:6px;font-size:12px">
        Tip: Ctrl/⌘+Shift+0 toggles this panel; Ctrl/⌘+Shift+Backspace clears.
      </div>
    </div>

    <script>
      // Preload bridges – accept any of these names the app may expose.
      const bridge =
        (window.icon && window.icon) ||
        (window.desktop && window.desktop) ||
        (window.electron && window.electron) || null;

      // Send "add sticker" to main via whichever bridge is available.
      function addSticker(payload) {
        try {
          if (window.icon?.addSticker) return window.icon.addSticker(payload);
          if (window.desktop?.addSticker) return window.desktop.addSticker(payload);
          if (window.electron?.ipcRenderer) return window.electron.ipcRenderer.send('icon:add-sticker', payload);
          console.warn('[icon:library] no preload bridge found; cannot add sticker');
        } catch (e) {
          console.error('[icon:library] addSticker failed', e);
        }
      }

      // Clear all overlays (if your preload exposes it).
      function clearOverlays() {
        try {
          if (window.icon?.clearOverlays) return window.icon.clearOverlays();
          if (window.desktop?.clearOverlays) return window.desktop.clearOverlays();
          if (window.electron?.ipcRenderer) return window.electron.ipcRenderer.send('icon:clear-overlays');
        } catch (e) {
          console.error('[icon:library] clearOverlays failed', e);
        }
      }

      // Update the counter when main broadcasts overlay-count.
      try {
        (window.icon?.onOverlayCount || window.desktop?.onOverlayCount)?.(function (n) {
          const el = document.getElementById('count');
          if (el) el.textContent = String(n);
        });
      } catch {}

      // Wire the Clear button.
      document.getElementById('clear')?.addEventListener('click', clearOverlays);

      // Listen to messages coming from inside the <webview>.
      const libview = document.getElementById('libview');
      libview.addEventListener('ipc-message', (ev) => {
        if (ev.channel === 'icon:webview-sticker' && ev.args && ev.args[0]) {
          addSticker(ev.args[0]); // { packId: 'url', stickerId, src }
        }
      });

      // Optional: show when the guest is ready
      libview.addEventListener('dom-ready', () => {
        libview.focus();
        console.debug('[icon:library] webview dom-ready');
      });
    </script>
  </body>
</html>
