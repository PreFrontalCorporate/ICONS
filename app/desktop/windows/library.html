<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>icon – library</title>
    <style>
      /* Full-bleed webview */
      html, body { height: 100%; margin: 0; background: #111; }
      #libview { position: fixed; inset: 0; border: 0; }

      /* Hide the small, generic overlay panel in this window (we keep the nicer HUD below) */
      #icon-overlay-panel { display: none !important; }

      /* Library HUD – wider, lighter, can't close */
      #hud {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 10;
        background: rgba(22,22,22,.92);
        color: #fff;
        padding: 14px 16px;
        border-radius: 14px;
        font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        box-shadow: 0 12px 28px rgba(0,0,0,.35);
        width: 360px;
        max-width: calc(100vw - 48px);
      }
      #hud button {
        appearance: none; border: 0; border-radius: 10px; padding: 6px 10px;
        background: #ef4444; color: #fff; font-weight: 600; cursor: pointer;
      }
      #count { font-variant-numeric: tabular-nums; }
    </style>
  </head>
  <body>
    <!-- Hosted library UI -->
    <webview id="libview" src="https://icon-web-two.vercel.app/library" allowpopups></webview>

    <!-- Overlays HUD -->
    <div id="hud" role="status" aria-live="polite">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px">
        <strong style="font-size:13px; letter-spacing:.3px;">Overlays</strong>
        <span id="count" style="opacity:.8; font-size:12px; margin-left:auto">0</span>
        <button id="clear" title="Close all overlays">Clear</button>
      </div>
      <div style="opacity:.7;font-size:12px">
        Tip: Ctrl/⌘+Shift+0 toggles this panel; Ctrl/⌘+Shift+Backspace clears.
      </div>
    </div>

    <script>
      // Prefer this new bridge; fall back to any older ones if present.
      const bridge =
        (window.icon && window.icon) ||
        (window.desktop && window.desktop) ||
        (window.electron && window.electron) || null;

      function addSticker(payload) {
        try {
          if (window.icon?.addSticker) return window.icon.addSticker(payload);
          if (window.desktop?.addSticker) return window.desktop.addSticker(payload);
          if (window.electron?.ipcRenderer) return window.electron.ipcRenderer.send('icon:add-sticker', payload);
          console.warn('[icon:library] no preload bridge found; cannot add sticker');
        } catch (e) {
          console.error('[icon:library] addSticker failed', e);
        }
      }

      function clearOverlays() {
        try {
          if (window.icon?.clearOverlays) return window.icon.clearOverlays();
          if (window.desktop?.clearOverlays) return window.desktop.clearOverlays();
          if (window.electron?.ipcRenderer) return window.electron.ipcRenderer.send('icon:clear-overlays');
        } catch (e) {
          console.error('[icon:library] clearOverlays failed', e);
        }
      }

      // Update HUD count when main broadcasts totals
      try {
        (window.icon?.onOverlayCount || window.desktop?.onOverlayCount)?.(function (n) {
          const el = document.getElementById('count');
          if (el) el.textContent = String(n);
        });
      } catch {}

      // Wire HUD
      document.getElementById('clear')?.addEventListener('click', clearOverlays);

      // Relay messages from the <webview> (webview-preload sends icon:webview-sticker)
      const libview = document.getElementById('libview');
      libview.addEventListener('ipc-message', (ev) => {
        if (ev.channel === 'icon:webview-sticker' && ev.args && ev.args[0]) {
          addSticker(ev.args[0]); // { packId, stickerId, src }
        }
      });

      libview.addEventListener('dom-ready', () => {
        libview.focus();
        console.debug('[icon:library] webview dom-ready');
      });
    </script>
  </body>
</html>
